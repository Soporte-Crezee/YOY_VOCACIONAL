if(typeof Object.create!=="function"){Object.create=function(a){function b(){}b.prototype=a;return new b}}var Search={init:function(a){var b=this;this.config=a;b.process=0;b.processAnterior=0;b.contador=1;this.selectedcontact=[];this.messagearea=a.messagearea;this.msheader=a.msheader;this.msmain=a.msmain;this.msfooter=a.msfooter;this.searchcontactContainer=a.searchcontactContainer;this.messageContainer=a.messageContainer;this.contact=a.contact;this.$imgSearchContact=$(this.config.searchmsContactContainer).find("input:image");this.messageContainerNotificacion=a.messageContainerNotificacion;this.notificacionId=a.hdnNotificacionID;this.mensajeNotificadoId=a.hdnMensajeID;b.bindEvents();b.setupTemplates();b.loadContacts();b.loadNotificacion();b.loadLastMensajes()},bindEvents:function(){var a=Search;this.config.txtcontactos.on("keypress",a.searchContact);this.config.btnconsultar.live("click",a.searchMessages);this.$imgSearchContact.live("click",a.contactSelected)},bindContactControls:function(){var a=Search;$(a.config.txtcontactos).autocomplete({source:a.sourceautocompletado,select:function(b,c){a.process=2;a.addContact(c);$(this).val("");return false}})},display:function(a){$(a).css({display:"block",visibility:"visible"})},hide:function(a){$(a).css({display:"none",visibility:"hidden"})},setupTemplates:function(){var a=Search;a.compiletemplateaddcontact=$(a.config.templateaddcontact).template()},fetchLastMessage:function(a){var b=Search;if(a.d.length<=0){if(b.contador===1){$(b.messageContainer).empty();var c="<span>No tiene mensajes</span>";$(b.msfooter).find("#more").html(c)}if(b.contador>1){$(b.messageContainer).empty();var c="<span>No existen más mensajes</span>";$(b.msfooter).find("#more").html(c)}return}else{$(b.messageContainer).empty();b.display(b.messageContainer);var d=$.tmpl(b.config.templatemessages,a.d);d.appendTo(b.messageContainer);var c='<a class="link_blue" onclick="javascript:Search.loadMoreMessage();">Mostrar más mensajes</a>';$(b.msfooter).find("#more").html(c);$('button[id|="btn-del"]').each(function(a){$(this).button({icons:{primary:"ui-icon-close"},text:false})});$('button[id|="btn-mas"]').each(function(a){$(this).button({icons:{primary:"ui-icon-circle-plus"},text:false})})}},refreshMessage:function(a){var b=Search;var c=$(b.messageContainer).find("div.mensajeoutput");var d=$.tmpl(b.config.templatemessages,a);var e=$(c).find("#"+a.mensajeid);var f=$(e).find("input:hidden");if(a.mensajeid==f.val()){e.parent().parent().parent().remove();d.appendTo(b.messageContainer)}else{d.appendTo(b.messageContainer)}},refreshMessages:function(){var a=Search;var b=a.contador;if(a.process===2){if(a.selectedcontact[0]&&a.selectedcontact[0].val!=undefined){var c=a.selectedcontact.val;$(a.messageContainer).empty();a.loadPagesMessages(1,b,c)}}if(a.process===0){$(a.messageContainer).empty();a.loadPagesMessages(1,b)}},loadPagesMessages:function(a,b,c){var d=Search;var e={};var f=new MensajeApi;var g=d.scrollTop-d.mensajeheight;if(c!=null||c!=undefined){var e={dto:{currentusuarioid:"0",remitenteid:c,currentpage:a}}}else{var e={dto:{currentusuarioid:"0",currentpage:a}}}var h=$.toJSON(e);f.LoadPageMensajes({success:function(c){if(c.d.length<=0)return;for(var e=1;e<c.d.length;e++){var f=$.tmpl(d.config.templatemessages,c.d[e]);f.appendTo(d.messageContainer);$('button[id|="btn-del"]').each(function(a){$(this).button({icons:{primary:"ui-icon-close"},text:false})});$('button[id|="btn-mas"]').each(function(a){$(this).button({icons:{primary:"ui-icon-circle-plus"},text:false})})}if(b>a){d.loadPagesMessages(a+1,b)}else{$("html, body").animate({scrollTop:g},400)}$("#content").unblock()}},h)},fetchMessage:function(a){var b=Search;if(a.d.length>0){if(b.process==3){var c=$.tmpl(b.config.templatemessages,a.d);$(b.config.messageContainerNotificacion).empty();b.display(b.config.messageContainerNotificacion);c.appendTo(b.config.messageContainerNotificacion)}if(b.process==0||b.process==2){if(b.contador<=1){$(b.messageContainer).empty()}for(var d=0;d<a.d.length;d++){rsmensaje=a.d[d];b.refreshMessage(rsmensaje)}}$('button[id|="btn-del"]').each(function(a){$(this).button({icons:{primary:"ui-icon-close"},text:false})});$('button[id|="btn-mas"]').each(function(a){$(this).button({icons:{primary:"ui-icon-circle-plus"},text:false})});var e='<a class="link_blue" onclick="javascript:Search.loadMoreMessage();">Mostrar más mensajes</a>';$(b.msfooter).find("#more").html(e)}else{if(b.contador===1){$(b.messageContainer).empty();var e="<span>No tiene mensajes</span>";$(b.msfooter).find("#more").html(e)}if(b.contador>1){var e="<span>No existen más mensajes</span>";$(b.msfooter).find("#more").html(e)}}},addContact:function(a){var b=Search;var c=false;this.contador=1;if(b.selectedcontact.length<=0){b.display(b.config.searchms);b.display(b.config.searchmsContactContainer);b.selectedcontact.push(a.item)}else{if(b.selectedcontact.length==1){b.display(b.config.searchms);b.display(b.config.searchmsContactContainer);b.selectedcontact.pop();b.selectedcontact.push(a.item)}}b.fetchContact()},removeContact:function(a){var b=Search;var c=false;this.contador=1;b.selectedcontact=[]},fetchContact:function(){var a=Search;if(a.process===2){a.config.contact.empty();var b=$.tmpl(a.compiletemplateaddcontact,a.selectedcontact);b.appendTo(a.config.contact);a.process=2;a.loadLastMensajes();a.process=2}},contactSelected:function(a){var b=Search;a.preventDefault();var c=$(this).parent().parent().parent().parent();b.removeContact(c);c.remove();b.endProcessSearch();b.process=0},loadLastMensajes:function(){var a=Search;var b={};var c=new MensajeApi;if(a.process===3){return}if(a.process===2){a.display(a.config.actions);a.display(a.config.msfooter);if(a.selectedcontact[0]&&a.selectedcontact[0].val!=undefined){var d=a.selectedcontact[0].val;b={dto:{currentusuarioid:"1",remitenteid:d}};var e=$.toJSON(b);c.LoadLastMensajes({success:function(b){a.fetchLastMessage(b)}},e);a.process=2}else{a.display(a.config.actions);a.display(a.config.msfooter);a.process=0;b={dto:{currentusuarioid:"0"}};var e=$.toJSON(b);c.LoadLastMensajes({success:function(b){a.fetchLastMessage(b)}},e);return}}if(a.process===0){a.display(a.config.actions);a.display(a.config.msfooter);b={dto:{currentusuarioid:"0"}};var e=$.toJSON(b);c.LoadLastMensajes({success:function(b){a.fetchLastMessage(b)}},e);return}a.process=0},loadNotificacion:function(){var a=Search;var b=a.mensajeNotificadoId.val();var c=a.notificacionId.val();var d=new NotificacionesApi;a.hide(a.config.actions);a.hide(a.config.msfooter);var e=new MensajeApi;if(b[0]){a.process=3;if(b=="0"){var f='<p style="text-align:center">No se encontró el mensaje seleccionado</p>';$(a.config.messageContainerNotificacion).html(f);a.display(a.config.messageContainerNotificacion);var g={dto:{notificacionid:c}};var h=$.toJSON(g);d.DeleteNotificacion({success:function(){}},h);return}var g={dto:{currentusuarioid:"0",mensajeid:b}};var h=$.toJSON(g);e.LoadLastMensajes({success:function(b){a.fetchMessage(b)}},h);var i={dto:{notificacionid:c}};var j=$.toJSON(i);oNotificacionesApi.ConfirmNotificacion({success:function(a){}},j)}},loadMoreMessage:function(){var a=Search;var b=a.contador;b=++b;a.contador=b;var c={};var d=new MensajeApi;if(a.process===2){if(a.selectedcontact[0]&&a.selectedcontact[0].val!=undefined){var e=a.selectedcontact[0].val;var c={dto:{currentusuarioid:"0",remitenteid:e,currentpage:b}};var f=$.toJSON(c);d.LoadPageMensajes({success:function(b){a.fetchMessage(b)}},f);a.process=2}}if(a.process===0){var c={dto:{currentusuarioid:"0",currentpage:b}};var f=$.toJSON(c);d.LoadPageMensajes({success:function(b){a.fetchMessage(b)}},f)}},endProcessSearch:function(){var a=Search;this.selectedcontact=[];this.contador=1;a.process=0;$(a.config.contactContainer).empty();$(a.config.contact).empty();a.hide(a.config.searchms);a.loadLastMensajes()},loadContacts:function(){var a=Search;var b=new ContactosApi;b.GetContactos({success:function(b){if(a.sourcecontacts===undefined){a.sourcecontacts=b;a.sourceautocompletado=[];$.map(a.sourcecontacts.d,function(b,c){a.sourceautocompletado.push({label:b.screenname,val:b.usuariosocialid})});a.bindContactControls()}}},null)},initProcessSearchMessages:function(){var a=Search;a.contador=1;a.selectedcontact=[];$(a.config.contactContainer).empty();$(a.config.contact).empty();a.hide(a.config.searchms);a.display(a.searchcontactContainer);var b="<span>Mostrar más mensajes</span>";$(a.msfooter).find("a.link_blue").html(b);$(a.config.btnsdelete).each(function(a){$(this).button({icons:{primary:"ui-icon-close"},text:false})});a.process=2},searchMessages:function(a){var b=Search;a.preventDefault();if(b.process===2){b.process=0;b.loadLastMensajes()}b.initProcessSearchMessages();b.process=0},askRemoveMessage:function(a){var b=Search;b.mensajeid=a;var c="¿Desea desvincularse de este mensaje?";var d=$(b.config.dialogquestion);d.find("#dialogtext").text(c);d.dialog({modal:true,resizable:false,closeText:c,buttons:[{text:"Ok",click:function(){$("#content").block({message:'<h1 style="font-size:20px;"><img src="../images/ajax-loader.gif" /> Buscando...</h1>'});b.removeMessage();$(this).dialog("close")}},{text:"Cancelar",click:function(){$(this).dialog("close")}}]})},removeMessage:function(){var a=Search;a.scrollTop=$(window).scrollTop();if(a.mensajeid!=undefined){var b=a.mensajeid;var c=$(a.messageContainer).find("#"+a.mensajeid);a.mensajeheight=c.parent().parent().parent().parent().height();var d=new MensajeApi;var e={dto:{mensajeid:b}};var f=$.toJSON(e);d.Delete({success:function(b){if(a.process==3){a.removeMessageUI(b);$("#content").unblock()}else{a.refreshMessages()}}},f)}},removeMessageUI:function(a){var b=Search;var c;if(b.process==3){c=$(b.config.messageContainerNotificacion).find("div."+b.mensajeid);$(c.parent()).remove();b.process=0;window.location.search=""}else{c=$(b.messageContainer).find("div."+b.mensajeid);$(c.parent()).remove()}},commentenable:function(a){var b=Search;var c=document.getElementById(a);var d={mensajeid:a};var e=$.toJSON(d);$("#panelcomment").remove().fadeIn("slow");$("#areacomTmpl").tmpl(d).appendTo(c).fadeIn(1e3);var f=$(c).find("#panelcomment").find("textarea");$(f).autoResize({onResize:function(){$(this).css({opacity:.9})},animateCallback:function(){$(this).css({opacity:1})},animateDuration:200,extraSpace:1});var g={maxCharacterSize:300,originalStyle:"display_info_textarea",warningStyle:"display_warning_textarea",warningNumber:300,displayFormat:"#left caracteres restantes de #max max."};$(f).textareaCount(g);f.focus()},cancelComment:function(){$("#panelcomment").remove().fadeIn("slow")},sendcomment:function(a,b){var c=Search;var d=new MensajeApi;var e=$("#txtComment").val();e=$.trim(e);if(e!=""&&a!=""){var f={dto:{mensajeid:a,contenido:e,asunto:"Respuesta"}};var g=$.toJSON(f);d.SendComment({success:function(a){c.showComment(a)}},g)}},showComment:function(a){var b=Search;var c=document.getElementById(a.d.guidconversacion);$(c).find("#panelcomment").remove();var d=$(c).children().find("div.comments");template=$.trim(b.config.templatecomment);fr="";$.each(a,function(a,b){fr+=template.replace(/{{remitenteid}}/ig,b.remitenteid).replace(/{{remitentenombre}}/ig,b.remitentenombre).replace(/{{contenido}}/ig,b.contenido).replace(/{{fechamensaje}}/ig,b.fechamensaje)});$(d).append(fr)},showContacts:function(a){var b=Search;var c=document.getElementById("#lsdestinatarios-"+a);var d=$(".destinatariosmnsj").find("#lsdestinatarios-"+a);$(d).slideToggle()},searchContact:function(a){if(a.keyCode==13)return false}};var NewMessage={init:function(a){var b=this;this.config=a;b.process=0;this.selectedcontacts=[];this.messagearea=a.messagearea;this.msheader=a.msheader;this.msmain=a.msmain;this.msfooter=a.msfooter;this.searchcontactContainer=a.searchcontactContainer;this.newmsContainer=a.newmsContainer;this.contactContainer=a.contactContainer;this.contactsContainer=a.contactsContainer;this.txtmensaje=a.txtmensaje;this.$imgContacto=$(this.contactsContainer).find("input:image");this.$iconClose=$(this.contactsContainer).find("span");b.bindEvents();b.setupTemplates();b.loadContacts();b.initProcessNewMesage()},bindEvents:function(){var a=NewMessage;a.config.txtcontactos.on("keypress",a.searchContact);a.config.txtcontactos.on("focusout",a.endSearchContact);a.config.btnenviar.on("click",a.saveMessage);a.config.btnnuevo.on("click",a.newMessage);a.$imgContacto.live("click",a.contactSelected);a.$iconClose.live("click",a.contactSelected);$(a.txtmensaje).autoResize({onResize:function(){$(this).css({opacity:.9})},animateCallback:function(){$(this).css({opacity:1})},animateDuration:200,extraSpace:1});var b={maxCharacterSize:300,originalStyle:"display_info_textarea",warningStyle:"display_warning_textarea",warningNumber:300,displayFormat:"#left caracteres restantes de #max max."};$(a.txtmensaje).textareaCount(b)},searchContact:function(a){if(a.keyCode==13)return false},endSearchContact:function(a){var b=NewMessage;b.hide(b.config.lblresultado)},bindContactControls:function(){var a=NewMessage;$(a.config.txtcontactos).autocomplete({source:function(b,c){var d=$.ui.autocomplete.filter(a.sourceautocompletado,b.term);if(!d.length){a.display(a.config.lblresultado)}else{a.hide(a.config.lblresultado)}c(d)},minLength:3,select:function(b,c){a.addContact(c);$(this).val("");return false}})},display:function(a){$(a).css({display:"block",visibility:"visible"})},hide:function(a){$(a).css({display:"none",visibility:"hidden"})},setupTemplates:function(){var a=NewMessage;a.compiletemplateaddcontact=$(a.config.templateaddcontact).template()},addContact:function(a){var b=NewMessage;var c=false;if(b.process===1){if(b.selectedcontacts.length<=0){b.selectedcontacts.push(a.item)}else{$.each(b.selectedcontacts,function(b,d){if(d.val===a.item.val){c=true;return}});if(!c){b.selectedcontacts.push(a.item)}}b.fetchContact()}},removeContact:function(a){var b=NewMessage;var c=false;if(b.process===1){if(b.selectedcontacts.length>0){var d=$(a).find("input:hidden");$.each(b.selectedcontacts,function(a,c){if(c.val==d.val()){delete b.selectedcontacts[a];return}});var e=[];$.each(b.selectedcontacts,function(a,b){if(b!==undefined)e.push(b)});b.selectedcontacts=e}}},fetchContact:function(){var a=NewMessage;if(a.process===1){a.config.contactContainer.empty();var b=$.tmpl(a.compiletemplateaddcontact,a.selectedcontacts);b.appendTo($(a.config.contactContainer))}},contactSelected:function(a){var b=NewMessage;a.preventDefault();if(b.process===1){var c=$(this).parent().parent().parent().parent();c.remove();b.removeContact(c)}},endProcessNewMessage:function(){var a=NewMessage;this.selectedcontacts=[];a.process=1;$(a.config.contactContainer).empty();a.txtmensaje.val("")},loadContacts:function(){var a=NewMessage;var b=new ContactosApi;b.GetContactos({success:function(b){if(a.sourcecontacts===undefined){a.sourcecontacts=b;a.sourceautocompletado=[];$.map(a.sourcecontacts.d,function(b,c){a.sourceautocompletado.push({label:b.screenname,val:b.usuariosocialid})});a.bindContactControls()}}},null)},initProcessNewMesage:function(){var a=NewMessage;$(a.config.contactContainer).empty();a.txtmensaje.val("");a.selectedcontacts=[];a.display(a.newmsContainer);a.display(a.searchcontactContainer);a.process=1},newMessage:function(a){var b=NewMessage;b.process=1;b.initProcessNewMesage()},saveMessage:function(){var a=NewMessage;a.process=4;var b=a.txtmensaje.val();var c="";var d="";if(a.selectedcontacts.length<=0){d+=" No se seleccionó contacto(s) para el mensaje. <br/>"}if(b===""){d+="   "+" No se encontró contenido en el mensaje. "}if(d===""){if(a.selectedcontacts.length>0){$.each(a.selectedcontacts,function(a,b){c+=b.val+"-"});var e=new MensajeApi;var f={dto:{contenido:a.txtmensaje.val(),asunto:a.process===4?" Nuevo Mensaje ":" Respuesta ",guidconversacion:a.guidconversacion,destinatariosstring:c}};var g=$.toJSON(f);e.Send({success:function(b){a.endProcessNewMessage(b);a.showDialog("Mensaje enviado")}},g);a.process=0}}else{a.showDialog(d);a.process=1}},showDialog:function(a){var b=NewMessage;var c=$(b.config.dialogquestion);c.find("#dialogtext").html(a);c.dialog({modal:true,resizable:false,closeText:"Error al enviar el mensaje.",buttons:[{text:"Ok",click:function(){$(this).dialog("close")}}]})}}